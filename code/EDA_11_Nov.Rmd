---
title: "BUAN 5510 - Capstone Project - EDA"
author: "Keith Castelino and Sourabh Gupta"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}


######### Seach for text ----   Data Cleaning has been completed, now the analysis   ----   ############

knitr::opts_chunk$set(
	fig.width = 8.5,
	# include = FALSE,
	# echo = FALSE,
	message = FALSE,
	warning = FALSE
)

options(tibble.print_max = 40, tibble.print_min = 25)

```

# Prepare your environment

Following needs to be done in order to prepare your environment:

+ Clean environment of all variables, functions and packages
+ Load packages required for analysis (only those that are required)
+ Set colour preferences for graphs
+ Load custom functions

Read in the raw data, as is required.

```{r echo = FALSE, message = FALSE, warning = FALSE, include = FALSE}

# Clear environment of variables and functions
rm(list = ls(all = TRUE)) 

# Clear environment of packages
if(is.null(sessionInfo()$otherPkgs) == FALSE) {
  lapply(paste("package:", names(sessionInfo()$otherPkgs), sep=""), 
         detach, character.only = TRUE, unload = TRUE)
}

# load required libraries (Use install.packages(tidyverse), for example, if needed)
library(tidyverse)
library(here)
library(readxl)
library(dlookr)
library(janitor)
library(stringr)
library(lubridate)
library(naniar)
library(zoo)
library(birk)
library(scales)
library(doBy)

# LOAD IN DATA

# # Data for SU Part 1 - Filed Cases and Hearings
# D11_filed_cases <- read_excel(here::here("data", "raw", "Data for SU Part 1 - Filed Cases and Hearings.xlsx"), sheet = "FiledCases SU") %>% clean_names()
# D12_case_event <- read_excel(here::here("data", "raw", "Data for SU Part 1 - Filed Cases and Hearings.xlsx"), sheet = "CaseEvents SU") %>% clean_names()
# D13_case_event_key <- read_excel(here::here("data", "raw", "Data for SU Part 1 - Filed Cases and Hearings.xlsx"), sheet = "CaseEvent Key") %>% clean_names()
# D14_case_type <- read_excel(here::here("data", "raw", "Data for SU Part 1 - Filed Cases and Hearings.xlsx"), sheet = "CaseType Key") %>% clean_names()
# 
# # Data for SU Part 2
# D21_charge <- read_excel(here::here("data", "raw", "Data for SU Part 2.xlsx"), sheet = "SU Charges") %>% clean_names()
# D22_charge_def <- read_excel(here::here("data", "raw", "Data for SU Part 2.xlsx"), sheet = "Charge Definitions") %>% clean_names()
# D23_dispo_key <- read_excel(here::here("data", "raw", "Data for SU Part 2.xlsx"), sheet = "Disposition Key") %>% clean_names()
# D24_crime_hist <- read_excel(here::here("data", "raw", "Data for SU Part 2.xlsx"), sheet = "SU CrimHist") %>% clean_names()
# 
# # Data for SU Part 3 - custody history
# D31_custody_hist <- read_excel(here::here("data", "raw", "Data for SU Part 3 - custody history.xlsx"), sheet = "CustodyHistory SU") %>% clean_names()

```

```{r}
#loading data
#
# xlsx files -- Data for SU Part 1 - Filed Cases and Hearings
D11_filed_cases <- read_excel("../Data/Data for SU Part 1 - Filed Cases and Hearings.xlsx", sheet = "FiledCases SU") %>% clean_names()
D12_case_event <- read_excel("../Data/Data for SU Part 1 - Filed Cases and Hearings.xlsx", sheet = "CaseEvents SU") %>% clean_names()
D13_case_event_key <- read_excel("../Data/Data for SU Part 1 - Filed Cases and Hearings.xlsx", sheet = "CaseEvent Key") %>% clean_names()
D14_case_type <- read_excel("../Data/Data for SU Part 1 - Filed Cases and Hearings.xlsx", sheet = "CaseType Key") %>% clean_names()
#
# xlsx files -- Data for SU Part 2
D21_charge <- read_excel("../Data/Data for SU Part 2.xlsx", sheet = "SU Charges") %>% clean_names()
D22_charge_def <- read_excel("../Data/Data for SU Part 2.xlsx", sheet = "Charge Definitions") %>% clean_names()
D23_dispo_key <- read_excel("../Data/Data for SU Part 2.xlsx", sheet = "Disposition Key") %>% clean_names()
D24_crime_hist <- read_excel("../Data/Data for SU Part 2.xlsx", sheet = "SU CrimHist") %>% clean_names()
#
# xlsx files -- Data for SU Part 3 - custody history
D31_custody_hist <- read_excel("../Data/Data for SU Part 3 - custody history.xlsx", sheet = "CustodyHistory SU") %>% clean_names()

# treated events_with_missing_status
events_with_missing_def_status <- read.csv("../calculated_data/events_with_missing_def_status.csv", header = TRUE)
#
```

# Cleaning the Data

To ensure that data is fit for analysis, we need to do the following:

+ Data structure: Ensure that the columns within each table are defined correctly
    + Confirm the data type is per expectation, and matches with definition in data dictionary
+ Derived variables: Define new columns based on data provided that are important factors for analysis

Summary for each of the datasets are below:

## D11_filed_cases

+ One record = one case
    + If there is more than one person involved in the same crime, they have different case numbers
    + A single defendant may be involved in more than one case
+ Date of Birth: Defendants need to be placed into age groups using **which date** -> New column introduced - `age_group`
+ We do not require these columns -> `DOB Anon`, `Referral Date`, `Event Code`, `Event Enter Date`, `Police Agency`,
                                    `Anon LE Number`

```{r}
D11_filed_cases <- D11_filed_cases %>% 
  mutate(
    dob_anon = ymd(dob_anon),
    event_enter_date = mdy(event_enter_date),
    age = interval(dob_anon, event_enter_date) %/% years(1),
    # age_group = cut(
    #   age, breaks = c(0, 18, 30, 40, 50, 60, 80),
    #   labels = c("LE_18", "20-30", "30-40", "40-50", "50-60", "GE_60"),
    #   order = TRUE
    # ),
    venue = fct_collapse(venue, Other = c("DCS", "DCW", "JUV"))
  ) %>% 
  mutate_at(c("gender", "venue", "case_types"), factor) %>% 
  select(-c(dob_anon, referral_date, event_code, police_agency, anon_le_number))

replace_na(list(gender = "Unknown"))
# write.csv(D11_filed_cases, '../calculated_data/D11_filed_cases.csv')  # for Basic Stat : PowerBI Visuals, Snapshot included below

hist(D11_filed_cases$event_enter_date, breaks = seq(min(D11_filed_cases$event_enter_date), max(D11_filed_cases$event_enter_date), length.out = 30))

summary(D11_filed_cases)

```

![D11](1.png)

![D11](1.1.png)
Missing Values:
  + We have `37 + 3 = 40` records where Gender is either missing or unknown
  + Case type has `8031` records with missing data
  + We don't have age or age group for 23 filed cases

## D12_case_event

+ One record = one event within a case
    + There is no **level** to this data
+ Event Docket Date: indicates the date of a future hearing
+ Event Code: indicates if the defendant failed to appear
    + missing values may include some `DEFFTA`
    + need to crosscheck with `Custody History SU` to fill up missing values in `Defendant Event Status`
+ We do not require these columns -> `Case Types`, `Venue`

```{r}
# event enter date is required to check when DFA happend
D12_case_event <- D12_case_event %>% 
  mutate(event_docket_date = ymd(event_docket_date)) %>% 
  mutate_at(c("defendant_event_status", "event_code"), factor) %>%
  select(-c(case_types, venue))

summary(D12_case_event)

# write.csv(D12_case_event, '../calculated_data/D12_case_event.csv')
```

![D12](2.png)

Missing Values:
  + We have `140515` records where event docket date is missing
  + We have `255192` records where Defendant event status is missing

## D13_case_event_key

+ Case stages need to be classified in 4 ways:
    + Arraignment
    + Pre Case Setting
    + Case Setting
    + Post Case Setting
+ We know what the following codes mean:
    + HRARRSC: Arraignment
    + HRCSGP, HRCSNWK, HRCSNWS, HRCSWK, HRCSWS: Case setting
+ Pre Case Setting: Any event that is after the last arraignment date
+ Post Case Setting: Any event that is after the first case setting date

```{r}

D13_case_event_key <- D13_case_event_key %>%
  # mutate_at(c("hearing_code"), factor) %>% 
  mutate(
    case_setting_stage = fct_collapse(
      hearing_code,
      arraignment = c("HRARRSC"),                                                      #--- (+) SG
      case_setting = c("HRCS", "HRCSGP", "HRCSNWK", "HRCSNWS", "HRCSWK", "HRCSWS"),
      # before = c(
      #   "CSHNOWV", "DEFBWO", "DRGTH", "HR1AP", "HR1APB", 
      #   "HR2AP", "HRBOND", "HRCOMP", "HRCOMPAR",
      #   "HRCOMPBS", "HRCOMPCS", "HRCOMPKA", "HRCOMPKC", 
      #   "HRCOMPKT", "HRCOMPTR", "HRCPLSNT", "HRCRMO"
      # ),
      # after = c(
      #   "HRCTCOMP", "HROM", "HROMCON", "HRPLEA", "HRPT", "HRSNTSC", "HRSTATCF", 
      #   "LECSREC", "MOCCAP", "TRSTSC", "TRSTSCCN", "WARARRDC", "WARARRSC"
      # ),
      drug_court = c("HRARDR", "HRBWSC", "HRDR1", "HRDR2", "HRDRC")                    #--- (+) SG: others -> drug_court
    ))
  # ) %>% 
  # replace_with_na(list(case_setting_stage = c("DEFFTA", "DEFFTABT")))

```

## D14_case_type

This dataset does not map to anything, so we will ignore it. 

## D21_charge

+ Offense end date treated the same as start date if not missing
+ Additional columns:
    + we have defined if charges are enhanced -> new calculated column `charge_enhanced` as Yes / No
+ We do not require these columns -> `Referral Date`, `Referral Charge(s)`, `Original Charge(s)`, `Warning`, `Description`

```{r}
D21_charge <- read_excel("../Data/Data for SU Part 2.xlsx", sheet = "SU Charges") %>% clean_names()

D21_charge <- D21_charge %>% 
  mutate_at(c("offense_start_date", "offense_end_date", "filing_date", "disposition_date"), mdy) %>% 
  # mutate_at(c("disposition_code"), factor) %>% 
  mutate(
    offense_end_date = if_else(is.na(offense_end_date), offense_start_date, offense_end_date),
    charge_enhanced = if_else(is.na(enhancements), "No", "Yes"),
    charge_code = str_to_upper(str_trim(
      str_split(string = current_charge_s, pattern = '-', n = 2, simplify = TRUE)[,1]
    ))
  ) %>% 
  select(-c(referral_date, referral_charge_s, original_charge_s, warning, current_charge_s, description, enhancements))

# write.csv(D21_charge, '../calculated_data/D21_charge.csv')
summary(D21_charge)
```

+ There are 8665 records where `disposition date` is empty
+ There are records where `filing date` is after the `disposition date`, need to confirm with David

+ Data Quality Issues

+ D21_charge:
    + There are 36 records where the filing date is earlier than the earliest offense start date
    + There are 1731 records where the filing date is earlier than the offense start date

```{r}

# D21_charge %>% 
#   group_by(file_number) %>% 
#   mutate(min_offense_start = min(offense_start_date)) %>% 
#   filter(filing_date < min_offense_start)
# 
# D21_charge %>% 
#   filter(filing_date < offense_start_date)

```

## D22_charge_def

+ Charges classed as:
    + felony v/s misdemeanour
    + violent v/s non-violent

```{r}
D22_charge_def <- D22_charge_def %>% 
  mutate(
    code = if_else(str_detect(code, "[A-Z]"), code, str_pad(code, 5, "left", "0")),
    # charge_class = case_when(
    #   class %in% c('A', 'B', 'C') ~ 2,                            # "Felony",
    #   class %in% c('U', 'GM') ~ 1,                                # "Misdemeanour",
    #   TRUE ~ 0                                                    # "Other"
    # ),
    is_violent = if_else(violent == 1, 1, 0)                      # "Yes", "No/Maybe"
  ) %>% 
  # mutate_at(c("charge_class", "is_violent"), factor) %>% 
  mutate(
    # charge_class = factor(
    #   charge_class, levels = c(0, 1, 2), ordered = TRUE                      # c("Other", "Misdemeanour", "Felony")
    # ),
    is_violent = factor(is_violent, levels = c(0, 1), ordered = TRUE),        # c("No/Maybe", "Yes")
    class = factor(class, levels = c('U', 'I', 'M', 'GM', 'C', 'B', 'A'), ordered = TRUE),
  ) %>%
  select(-c(violent))
```

## D23_dispo_key

+ Description used to identify the verdict (this is an approximation)
+ Disposition type is recategorized

```{r}
D23_dispo_key <- D23_dispo_key %>% 
  # mutate_at(c("type"), factor) %>% 
  mutate(
    type = fct_collapse(type, Other = c("Dismissed", "Decline or Other/Error")),
    verdict = case_when(
      str_detect(tolower(description), "guilty") ~ "guilty",
      str_detect(tolower(description), "acquit") ~ "acquitted",
      TRUE ~ "other"
    )
  ) %>% 
  mutate_at(c("verdict"), factor)
```

## D24_crime_hist

+ Confirmed that "Display Sequence" is based on the order of offenses
+ Historical records classified based on age group and charge class
+ In-state v/s Out-of-state history identified
+ Three new columns are introduced -> `history_in_state`, `last_crime_period`, `total_crimes`

```{r}

D24_crime_hist <- D24_crime_hist %>% 
  mutate(
    jurisdiction_state = str_extract(jursidiction, "\\b[A-Z]{2}"),
    age_group = if_else(startsWith(conviction_level, 'J'), "juvenile", "adult"),
    charge_class = if_else(endsWith(conviction_level, 'M'), "misdemeanour", "felony"),
    history_in_state = jurisdiction_state == 'WA',
    last_crime = as.numeric((Sys.Date() - as.Date(offense_date)) / 365),
    last_crime_period = cut(
      last_crime, breaks = c(0, 3, 10, 110),
      labels = c("<=3", "3-10", ">10")
    )
  ) %>%
  group_by(defendant_id) %>%
  mutate(total_crimes = length(defendant_id)) %>% 
  select(-c(jurisdiction_state, conviction_level, last_crime)) %>%
  ungroup()

# criminal history sort by recent crime per file number
crime_hist_by_file <- D24_crime_hist %>%
                        group_by(defendant_id) %>% 
                        arrange(last_crime_period) %>%
                        slice(1) %>%
                        ungroup()

summary(D24_crime_hist)
```

+ Offense date is missing in `767` records
+ Max offense date is for year `9116`, which is not possible, so data is not good
+ Max Conviction date is for year `6200`, which is also not possible, data is not good

```{r}
ggplot(D24_crime_hist, aes(x = last_crime_period)) + 
  geom_bar() +
geom_text(stat='count', aes(label=..count..), vjust=-0.7)

hist(D24_crime_hist$total_crimes)
```


## D31_custody_hist

```{r}

D31_custody_hist <- D31_custody_hist %>% 
  mutate_at(c("current_status", "custody_status_history", "status_update_user"), factor) %>% 
  mutate(
    status_update_user = fct_lump(status_update_user, other_level = "OTHER"),
    status_history_date = excel_numeric_to_date(as.numeric(status_history_date), "modern"),
    current_status_date = as.Date(current_status_date)
  )

```


## Further data cleaning

The data is further trimmed based on the following:

+ D11_filed_cases:
    + Case types that occur less than 1% are grouped as "Other"
    + Case types with missing values are classified as "Unknown"
    + Missing values replaced in age group and gender variables
+ D12_case_event:
    + Case events with missing docket dates are eliminated
    + CSHNOWV: will never have a docket date
    + HRCS, TRSTSCCN, HRCSGP, HROMCON, HRSNTSC: missing due to (possibly) human error
    + most other event codes with missing values each occur in less than 1% of events
+ D31_custody_history:
    + Filling 

```{r}

# classifying case types that occur less than 1% as "Other"
# missing case types classified as "Unknown"

# D11_filed_cases %>%
#   diagnose_category(top = 25, add_character = TRUE) %>%
#   filter(variables == "case_types") %>%
#   arrange(desc(freq))

D11_filed_cases <- D11_filed_cases %>%
  mutate(
    # case_types = fct_lump(case_types, prop = 0.01),
    case_types = fct_explicit_na(case_types, na_level = "Unknown")
    # age_group = fct_explicit_na(age_group, na_level = "Unknown")
  ) %>% 
  replace_na(list(gender = "Unknown"))

# D12_case_event <- D12_case_event %>% 
#   filter(!(is.na(event_docket_date) & event_code != "DEFFTA"))

D21_charge <- D21_charge %>% 
  filter(!(is.na(disposition_date) | is.na(disposition_code)))

```

### Missing values for defendant event status

Highlight all lines and hit Ctrl+C to uncomment

Need to read in the CSV file to work with it for further EDA

```{r}
# remove all the duplicates
events_with_missing_def_status <- events_with_missing_def_status[!duplicated(events_with_missing_def_status), ]

# keep only records where there is DEFFTA, and first event_enter_date of each file_number
events_with_missing_def_status <- events_with_missing_def_status[events_with_missing_def_status$event_code == 'DEFFTA', ] %>%
                        group_by(file_number) %>%
                        arrange(file_number, event_enter_date) %>%
                        slice(1) %>%
                        ungroup() %>%
                        select(-c(event_code, event_enter_date, event_docket_corrected))
```

## Data Cleaning has been completed, now the analysis

## Capstone Meeting Updates - 10/22/2019

1.	 Representative charge for each File Number as one File Number may have multiple charges. -> `D11_cases_rep_charge`

2.	 Critical stage of a case is case setting  (Arraignment, case setting, before case setting, after case setting) -> `D12_D13_case_event_stages`

3.	Last Arraignment Date -> `D12_D13_case_event_stages`

4.	Filling missing Defendant_Event_Status field in CaseEvents table -> `events_with_missing_status`

## Representative Charges

+ representative charge for each File Number as one File Number may have multiple charges.
+ Datasets required --> D11, D21, D22
+ Order of precedence -> Charge Class, Seriousness, violent

```{r}
# join D21_charge and D22_charge_def to get charge class, seriousness and violent information for each file number
represent_charge_by_file <- left_join(D21_charge, D22_charge_def, by = c("charge_code" = "code")) %>%
                              select(-c(description))

# arrange/sort records as File_number-ASC, Class-DESC, Seriousness-DESC, Violent-DESC
represent_charge_by_file <- represent_charge_by_file %>%
                              group_by(file_number) %>% 
                              arrange(file_number, desc(class),
                                    desc(seriousness), desc(is_violent)) %>%
                              slice(1) %>%
                              ungroup()  %>%
                              select(-c(offense_start_date, offense_end_date, filing_date,
                                        disposition_date, disposition_code, charge_enhanced))

```

##  Critical stage of a case is case setting  (Arraignment, case setting, before case setting, after case setting)
  
```{r}
# D12_case_events and D13_case_event_key to map the hearing codes to get 3 things, arraignment, case_setting, drug_court
cs_1 <- left_join(D12_case_event, D13_case_event_key, by = c("event_code" = "hearing_code")) %>%
                                select(-c(description))

# last arraignment date for each file number
last_arr_date_by_file <- cs_1[cs_1$case_setting_stage == 'arraignment', ] %>%
                        select(-c(defendant_id, event_code, event_enter_date, defendant_event_status)) %>%
                        group_by(file_number) %>% 
                        arrange(file_number, desc(event_docket_date)) %>%
                        slice(1) %>%
                        ungroup()

colnames(last_arr_date_by_file)[colnames(last_arr_date_by_file) == 'event_docket_date'] <- 'last_arr_date'
colnames(last_arr_date_by_file)[colnames(last_arr_date_by_file) == 'case_setting_stage'] <- 'arraignment'

# first case setting date for each file number
first_cs_date_by_file <- cs_1[cs_1$case_setting_stage == 'case_setting', ] %>%
                        select(-c(defendant_id, event_code, event_enter_date, defendant_event_status)) %>%
                        group_by(file_number) %>% 
                        arrange(file_number, event_docket_date) %>%
                        slice(1) %>%
                        ungroup()

colnames(first_cs_date_by_file)[colnames(first_cs_date_by_file) == 'event_docket_date'] <- 'first_cs_date'
colnames(first_cs_date_by_file)[colnames(first_cs_date_by_file) == 'case_setting_stage'] <- 'case_setting'

# join 3 dataframes (cs_1, last_arr_date_by_file, first_cs_date_by_file) to get last_arraignment_date and first_case_setting_date for each file number
cs_2 <- left_join(cs_1, last_arr_date_by_file, by = c("file_number")) %>%
                                select(-c(arraignment))
cs_2 <- left_join(cs_2, first_cs_date_by_file, by = c("file_number")) %>%
                                select(-c(case_setting))

# new column with 4 categories: A(Arraignment), B(Before Case Setting), C(Case Setting), D(After Case Setting)
case_stage_by_file <- cs_2 %>%  
      mutate(case_stage = ifelse(case_setting_stage == 'drug_court', 'E(Drug court)', 
                            ifelse(event_docket_date <= last_arr_date , 'A(Arraignment)', 
                              ifelse(event_docket_date > last_arr_date & event_docket_date < first_cs_date, 'B(Before Case Setting)',
                                ifelse(event_docket_date == first_cs_date, 'C(Case Setting)',
                                  ifelse(event_docket_date > first_cs_date, 'D(After Case Setting)', event_code)))))) %>%
  select(-c(case_setting_stage))

# filter only records where event_code is DEFFTA
dfa_file_cases <- case_stage_by_file[case_stage_by_file$event_code == 'DEFFTA', ]

# new column with 5 categories: A(Arraignment), B(Before Case Setting), C(Case Setting), D(After Case Setting), E(Drug court)
case_stage_by_file <- case_stage_by_file %>%  
      mutate(case_stage_dfa =ifelse(is.na(case_stage), (ifelse((!is.na(last_arr_date) | (!is.na(last_arr_date) & is.na(first_cs_date))) & event_enter_date <= last_arr_date , 'A(Arraignment)', 
                                ifelse((!is.na(first_cs_date) & !is.na(last_arr_date)) & (event_enter_date < first_cs_date & event_enter_date > last_arr_date), 'B(Before Case Setting)',
                                  ifelse(!is.na(first_cs_date) & event_enter_date == first_cs_date, 'C(Case Setting)',
                                    ifelse(!is.na(first_cs_date) & event_enter_date > first_cs_date, 'D(After Case Setting)', 
                                      ifelse(is.na(first_cs_date) & is.na(last_arr_date), 'E(Drug court)',
                                        ifelse((((is.na(last_arr_date) & !is.na(first_cs_date)) & event_enter_date < first_cs_date) | ((!is.na(last_arr_date) & is.na(first_cs_date)) & event_enter_date > last_arr_date)), 'B(Before Case Setting)', case_stage))))))), case_stage))

# keeping only records which have these 5 values as above
case_stage_by_file = filter(case_stage_by_file, (case_stage_dfa %in% c("A(Arraignment)", "B(Before Case Setting)", "C(Case Setting)", "D(After Case Setting)", "E(Drug court)")))

# total DFA by file
# case_stage_by_file <- case_stage_by_file %>%
#                         group_by(file_number) %>%
#                         summarise(total_dfa = sum(event_code == "DEFFTA")) 

# Earliest DEFFTA  at which stage for each file number
case_stage_by_file <- case_stage_by_file %>%
                        group_by(file_number) %>%  
                        mutate(total_dfa = length(which(event_code == "DEFFTA"))) %>%
                        arrange(file_number, event_enter_date) %>%
                        slice(1) %>%
                        select(c(file_number, case_stage_dfa, total_dfa)) %>%
                        ungroup()

# new column in "case_stage_by_file" matching with "dfa_file_cases" to check if filed case has DEFFTA
case_stage_by_file$dfa <- ifelse(is.na(match(case_stage_by_file$file_number, dfa_file_cases$file_number)),"No", "Yes")

# Remove un-necessary datasets
rm(cs_1, cs_2, dfa_file_cases)

```


## preparing dataset for DFA rate EDA in powerBI

```{r}
# We need DFA rates by 
# Age-group, Gender, Venue           -- in D11_filed_cases dataset
# charge class, seriousness, violent -- in represent_charge_by_file
# Criminal History                   -- in D24_crime_hist / crime_hist_by_file
# Critical stage of case             -- in case_stage_by_file
# Custody Status                     -- events_with_missing_value

rm(dfa_by_category, dfa_for_model)

# Age-group, Gender, Venue, charge class, seriousness, violent per file number
dfa_by_category <- merge(x = D11_filed_cases, y = represent_charge_by_file, by = "file_number", all.x=TRUE) %>%
                      select(-c(event_enter_date))

# new column in "dfa_by_category" matching with "D24_crime_hist" to get criminal history status in Yes or No
dfa_by_category$crime_hist <- ifelse(is.na(match(dfa_by_category$defendant_id, D24_crime_hist$defendant_id)),"No", "Yes")

# now for the files which have DFA atleast once with stage of the case -- case_stage_by_file
dfa_by_category <- merge(x = dfa_by_category, y = case_stage_by_file, by = "file_number", all.x=TRUE)

# adding custody status of the defendant as well
dfa_by_category <- merge(x = dfa_by_category, y = events_with_missing_def_status, by = c("file_number", "defendant_id"), all.x=TRUE)

# export dfa_by_category to csv for powerbi
# ###### write.csv(dfa_by_category, '../calculated_data/dfa_by_category_eda.csv')

# summary(dfa_by_category)
# summary(D11_filed_cases)
```

```{r}

dfa_for_model <- dfa_by_category %>%
                      select(-c(case_types, charge_code, file_number, defendant_id))

# 1. delete records where gender is "Unknown"
dfa_for_model <- dfa_for_model[!(dfa_for_model$gender=="Unknown"),]
# 2. FIll nas in age with mean of the column
# dfa_for_model <- dfa_for_model[, age := na.aggregate(age)]

# fill missing of seriousness
class_serious <- D22_charge_def %>%
                  group_by(class) %>%
                  dplyr::summarize(Mean = mean(seriousness, na.rm=TRUE))

class_serious <- class_serious[!is.na(class_serious$class),]

dfa_for_model$seriousness[is.na(dfa_for_model$seriousness)] <- class_serious$Mean[match(dfa_for_model$class, class_serious$class)][which(is.na(dfa_for_model$seriousness))]

rm(class_serious)


mean(my.xldataset$mcs1, na.rm=TRUE)

dfa_for_model$class <- ifelse(is.na(dfa_for_model$class), 'Other', dfa_for_model$class)
dfa_for_model$class <- as.factor(dfa_for_model$class)

dfa_for_model$seriousness <- ifelse(is.na(dfa_for_model$seriousness), 99, dfa_for_model$seriousness)
dfa_for_model$seriousness <- as.factor(dfa_for_model$seriousness)

dfa_for_model$is_violent <- ifelse(is.na(dfa_for_model$is_violent), 0, dfa_for_model$is_violent)

dfa_for_model$defendant_status <- ifelse(is.na(dfa_for_model$defendant_status), 'Other', dfa_for_model$defendant_status)
dfa_for_model$defendant_status <- as.numeric(as.factor(dfa_for_model$defendant_status))

dfa_for_model$gender      <- as.numeric(dfa_for_model$gender)
dfa_for_model$venue       <- as.numeric(dfa_for_model$venue)
# dfa_for_model$age_group   <- as.numeric(dfa_for_model$age_group)
dfa_for_model$class       <- as.numeric(dfa_for_model$class)
dfa_for_model$is_violent  <- as.numeric(dfa_for_model$is_violent)
dfa_for_model$case_stage_dfa   <- as.numeric(as.factor(dfa_for_model$case_stage_dfa))

# dfa_for_model$dfa <- ifelse(dfa_for_model$dfa == 'Yes', 1, 0)
dfa_for_model$crime_hist <- ifelse(dfa_for_model$crime_hist == 'Yes', 1, 0)


str(dfa_for_model)
summary(dfa_for_model)

# export dfa_by_category to csv for powerbi
write.csv(dfa_for_model, '../calculated_data/dfa_for_model.csv')

```

# DFA Rate by Category

![DFA_1](dfa_1.png)

![DFA_2](dfa_2.png)

# Disposition time

## Data Preparation
```{r}
# megre D21_charges table with last_arr_date_by_file to get last arraignement date for each file number
# new columns : (i)   total_dispo_date   -> how many disposition date one file number has
#               (ii)  dispo_time_filing  -> time to disposition comparing filing date
#               (iii) dispo_time_arraign -> time to disposition comparing last arraignement date of file
file_last_arr <- merge(x = D21_charge, y = last_arr_date_by_file, by = "file_number", all.x=TRUE) %>%
                        group_by(file_number) %>%
                          mutate(total_dispo_date = length(unique(disposition_date))) %>%
                        ungroup() %>%
                          mutate(dispo_time_filing  = as.Date(disposition_date) - as.Date(filing_date)) %>%
                          mutate(dispo_time_arraign = as.Date(disposition_date) - as.Date(last_arr_date)) %>%
                            select(-c(arraignment, offense_start_date, offense_end_date))

# convert new column in to numeric datatype
file_last_arr$dispo_time_filing  <- as.numeric(as.character(file_last_arr$dispo_time_filing))
file_last_arr$dispo_time_arraign <- as.numeric(as.character(file_last_arr$dispo_time_arraign))

# histogram for count of disposition date
hist(file_last_arr$total_dispo_date)

# histogram for time to disposition comparing filing date
hist(file_last_arr$dispo_time_filing, col="orange", 
     xlim=c(-500,1500), breaks=280)

# histogram for time to disposition comparing last arraignement date of file
hist(file_last_arr$dispo_time_arraign, col="orange",
     xlim=c(-500,1500), breaks=280)

# rm(file_last_arr)

```

```{r}
# merge file_last_arr with D23_dispo_key to get disposition ranking
dispo_time_dispo_rank <- merge(x = file_last_arr, y = D23_dispo_key, by = "disposition_code", all.x=TRUE) %>%
                            group_by(file_number, charge_code) %>% 
                            arrange(file_number, ranking) %>%
                            slice(1) %>%
                            ungroup() %>% 
                          select(c(file_number, filing_date, disposition_date, charge_enhanced, charge_code, last_arr_date, 
                                   total_dispo_date, dispo_time_filing, dispo_time_arraign, disposition_code, ranking, type))

rm(file_last_arr)

# for each file number in dispo_time_dispo_rank dataframe, get from dfa_by_category df
# Age-group, Gender, Venue           
# charge class, seriousness, violent 
# Criminal History                   
# Custody Status
dispo_by_category <- merge(x = dispo_time_dispo_rank, y = dfa_by_category, by = "file_number", all.x=TRUE) %>%  
      mutate(serious_cat = ifelse(seriousness <= 5, '<=5', 
                            ifelse(seriousness > 5 & seriousness <= 10, '5-10', 
                              ifelse(seriousness > 5, '>10', seriousness))))  %>%
                         select(-c(filing_date, disposition_date, last_arr_date, case_types, charge_code.y,
                                   event_code, case_stage_dfa, seriousness))
```


## Drug Court Cases

```{r}
dg_1 <- left_join(D12_case_event, D13_case_event_key, by = c("event_code" = "hearing_code")) %>%
                                select(-c(description))

# delete records which are not drug cases
dg_1 <- dg_1[(dg_1$case_setting_stage == "drug_court"), ]

#
# new column in "dispo_by_category" matching with "dg_1" to get criminal history status in Yes or No
dispo_by_category$drug_court <- ifelse(is.na(match(dispo_by_category$file_number, dg_1$file_number)),"No", "Yes")

rm(dg_1)

```

## Filing date - Histogram and Basic stats

```{r}
# disposition time comparing filing date for age group
ggplot(dispo_by_category,aes(x=dispo_time_filing)) +
  geom_histogram()  + 
    xlim(c(-200,1200)) + facet_grid(~age_group) + ggtitle("for age group")

# age group
summaryBy(dispo_time_filing ~ age_group, data = dispo_by_category, 
          FUN = list(mean, max, min, median))
#-----------------------------------------------------

# disposition time comparing filing date for gender
ggplot(dispo_by_category,aes(x=dispo_time_filing)) +
  geom_histogram()  + 
    xlim(c(-200,1200)) + facet_grid(~gender) + ggtitle("for gender")

# gender
summaryBy(dispo_time_filing ~ gender, data = dispo_by_category, 
          FUN = list(mean, max, min, median))
#-----------------------------------------------------

# disposition time comparing filing date for Criminal History
ggplot(dispo_by_category,aes(x=dispo_time_filing)) +
  geom_histogram()  + 
    xlim(c(-200,1200)) + facet_grid(~crime_hist) + ggtitle("Criminal History")

# crime_hist
summaryBy(dispo_time_filing ~ crime_hist, data = dispo_by_category, 
          FUN = list(mean, max, min, median))
#-----------------------------------------------------

# disposition time comparing filing date for venue
ggplot(dispo_by_category,aes(x=dispo_time_filing)) +
  geom_histogram()  + 
    xlim(c(-200,1200)) + facet_grid(~venue) + ggtitle("for venue")

# venue
summaryBy(dispo_time_filing ~ venue, data = dispo_by_category, 
          FUN = list(mean, max, min, median))
#-----------------------------------------------------

# disposition time comparing filing date for Charge class
ggplot(dispo_by_category,aes(x=dispo_time_filing)) +
  geom_histogram()  + 
    xlim(c(-200,1200)) + facet_grid(~class) + ggtitle("Charge class")

# class
summaryBy(dispo_time_filing ~ class, data = dispo_by_category, 
          FUN = list(mean, max, min, median))
#-----------------------------------------------------

# disposition time comparing filing date for Seriousness
ggplot(dispo_by_category,aes(x=dispo_time_filing)) +
  geom_histogram()  + 
    xlim(c(-200,1200)) + facet_grid(~serious_cat) + ggtitle("Seriousness")

# serious_cat
summaryBy(dispo_time_filing ~ serious_cat, data = dispo_by_category, 
          FUN = list(mean, max, min, median))
#-----------------------------------------------------

# disposition time comparing filing date for Custody Status
ggplot(dispo_by_category,aes(x=dispo_time_filing)) +
  geom_histogram()  + 
    xlim(c(-200,1200)) + facet_grid(~defendant_status) + ggtitle("Custody Status")

# defendant_status
summaryBy(dispo_time_filing ~ defendant_status, data = dispo_by_category, 
          FUN = list(mean, max, min, median))
#-----------------------------------------------------

# disposition time comparing filing date for Drug Cases
ggplot(dispo_by_category,aes(x=dispo_time_filing)) +
  geom_histogram()  + 
    xlim(c(-200,1200)) + facet_grid(~drug_court) + ggtitle("Drug Cases")

# drug_court
summaryBy(dispo_time_filing ~ drug_court, data = dispo_by_category, 
          FUN = list(mean, max, min, median))
#-----------------------------------------------------
```

## last Arraignment date - Histogram and Basic stats

```{r}
# disposition time comparing last arraignment date for age group
ggplot(dispo_by_category,aes(x=dispo_time_arraign)) +
  geom_histogram()  + 
    xlim(c(-200,1200)) + facet_grid(~age_group) + ggtitle("for age group")

# age group
summaryBy(dispo_time_arraign ~ age_group, data = dispo_by_category, 
          FUN = list(mean, max, min, median), na.rm=TRUE)
#-----------------------------------------------------

# disposition time comparing last arraignment date for gender
ggplot(dispo_by_category,aes(x=dispo_time_arraign)) +
  geom_histogram()  + 
    xlim(c(-200,1200)) + facet_grid(~gender) + ggtitle("for gender")

# gender
summaryBy(dispo_time_arraign ~ gender, data = dispo_by_category, 
          FUN = list(mean, max, min, median), na.rm=TRUE)
#-----------------------------------------------------

# disposition time comparing last arraignment date for Criminal History
ggplot(dispo_by_category,aes(x=dispo_time_arraign)) +
  geom_histogram()  + 
    xlim(c(-200,1200)) + facet_grid(~crime_hist) + ggtitle("Criminal History")

# crime_hist
summaryBy(dispo_time_arraign ~ crime_hist, data = dispo_by_category, 
          FUN = list(mean, max, min, median), na.rm=TRUE)
#-----------------------------------------------------

# disposition time comparing last arraignment date for venue
ggplot(dispo_by_category,aes(x=dispo_time_arraign)) +
  geom_histogram()  + 
    xlim(c(-200,1200)) + facet_grid(~venue) + ggtitle("for venue")

# venue
summaryBy(dispo_time_arraign ~ venue, data = dispo_by_category, 
          FUN = list(mean, max, min, median), na.rm=TRUE)
#-----------------------------------------------------

# disposition time comparing last arraignment date for Charge class
ggplot(dispo_by_category,aes(x=dispo_time_arraign)) +
  geom_histogram()  + 
    xlim(c(-200,1200)) + facet_grid(~class) + ggtitle("Charge class")

# class
summaryBy(dispo_time_arraign ~ class, data = dispo_by_category, 
          FUN = list(mean, max, min, median), na.rm=TRUE)
#-----------------------------------------------------

# disposition time comparing last arraignment date for Seriousness
ggplot(dispo_by_category,aes(x=dispo_time_arraign)) +
  geom_histogram()  + 
    xlim(c(-200,1200)) + facet_grid(~serious_cat) + ggtitle("Seriousness")

# serious_cat
summaryBy(dispo_time_arraign ~ serious_cat, data = dispo_by_category, 
          FUN = list(mean, max, min, median), na.rm=TRUE)
#-----------------------------------------------------

# disposition time comparing last arraignment date for Custody Status
ggplot(dispo_by_category,aes(x=dispo_time_arraign)) +
  geom_histogram()  + 
    xlim(c(-200,1200)) + facet_grid(~defendant_status) + ggtitle("Custody Status")

# defendant_status
summaryBy(dispo_time_arraign ~ defendant_status, data = dispo_by_category, 
          FUN = list(mean, max, min, median), na.rm=TRUE)
#-----------------------------------------------------

# disposition time comparing last arraignment date for Drug Cases
ggplot(dispo_by_category,aes(x=dispo_time_arraign)) +
  geom_histogram()  + 
    xlim(c(-200,1200)) + facet_grid(~drug_court) + ggtitle("Drug Cases")

# drug_court
summaryBy(dispo_time_arraign ~ drug_court, data = dispo_by_category, 
          FUN = list(mean, max, min, median), na.rm=TRUE)
#-----------------------------------------------------
```

# Relation b/w DFA and Disposition time

```{r}
ggplot(dispo_by_category[dispo_by_category$age_group != "Unknown", ], aes(x=total_dfa, y=dispo_time_filing)) +
  geom_point(stat = "summary", fun.y = "mean") +
  facet_grid(~age_group)  + ggtitle("for age group")

ggplot(dispo_by_category, aes(x=total_dfa, y=dispo_time_filing)) +
  geom_point(stat = "summary", fun.y = "mean") +
  facet_grid(~gender) + ggtitle("for gender")

ggplot(dispo_by_category, aes(x=total_dfa, y=dispo_time_filing)) +
  geom_point(stat = "summary", fun.y = "mean") +
  facet_grid(~crime_hist) + ggtitle("Criminal History")

ggplot(dispo_by_category, aes(x=total_dfa, y=dispo_time_filing)) +
  geom_point(stat = "summary", fun.y = "mean") +
  facet_grid(~venue) + ggtitle("for venue")

ggplot(dispo_by_category, aes(x=total_dfa, y=dispo_time_filing)) +
  geom_point(stat = "summary", fun.y = "mean") +
  facet_grid(~class) + ggtitle("Charge class")

ggplot(dispo_by_category, aes(x=total_dfa, y=dispo_time_filing)) +
  geom_point(stat = "summary", fun.y = "mean") +
  facet_grid(~serious_cat) + ggtitle("Seriousness")

ggplot(dispo_by_category, aes(x=total_dfa, y=dispo_time_filing)) +
  geom_point(stat = "summary", fun.y = "mean") +
  facet_grid(~defendant_status) + ggtitle("Custody Status")

ggplot(dispo_by_category, aes(x=total_dfa, y=dispo_time_filing)) +
  geom_point(stat = "summary", fun.y = "mean") +
  facet_grid(~drug_court) + ggtitle("Drug Cases")
```


```{r}
ggplot(dispo_by_category[dispo_by_category$age_group != "Unknown", ], aes(x=total_dfa, y=dispo_time_arraign)) +
  geom_point(stat = "summary", fun.y = "mean") +
  facet_grid(~age_group)  + ggtitle("for age group")

ggplot(dispo_by_category, aes(x=total_dfa, y=dispo_time_arraign)) +
  geom_point(stat = "summary", fun.y = "mean") +
  facet_grid(~gender) + ggtitle("for gender")

ggplot(dispo_by_category, aes(x=total_dfa, y=dispo_time_arraign)) +
  geom_point(stat = "summary", fun.y = "mean") +
  facet_grid(~crime_hist) + ggtitle("Criminal History")

ggplot(dispo_by_category, aes(x=total_dfa, y=dispo_time_arraign)) +
  geom_point(stat = "summary", fun.y = "mean") +
  facet_grid(~venue) + ggtitle("for venue")

ggplot(dispo_by_category, aes(x=total_dfa, y=dispo_time_arraign)) +
  geom_point(stat = "summary", fun.y = "mean") +
  facet_grid(~class) + ggtitle("Charge class")

ggplot(dispo_by_category, aes(x=total_dfa, y=dispo_time_arraign)) +
  geom_point(stat = "summary", fun.y = "mean") +
  facet_grid(~serious_cat) + ggtitle("Seriousness")

ggplot(dispo_by_category, aes(x=total_dfa, y=dispo_time_arraign)) +
  geom_point(stat = "summary", fun.y = "mean") +
  facet_grid(~defendant_status) + ggtitle("Custody Status")

ggplot(dispo_by_category, aes(x=total_dfa, y=dispo_time_arraign)) +
  geom_point(stat = "summary", fun.y = "mean") +
  facet_grid(~drug_court) + ggtitle("Drug Cases")
```


<!-- ```{r} -->
<!-- dispo_time <- D21_D22_charges %>% -->
<!--               group_by(file_number) %>%  -->
<!--               arrange(file_number, desc(disposition_date)) %>% -->
<!--               slice(1) %>% -->
<!--               ungroup() %>% -->
<!--               select(file_number, filing_date, disposition_date) -->

<!-- dispo_time <- D12_D13_case_event_stages %>% -->
<!--               left_join(dispo_time, by = c("file_number")) %>% -->
<!--               select(file_number, last_arr_date, case_stage, filing_date, disposition_date) %>% -->
<!--               mutate(time_for_dispo_filing = as.Date(disposition_date) - as.Date(filing_date)) %>% -->
<!--               mutate(time_for_dispo_arraign = as.Date(disposition_date) - as.Date(last_arr_date)) -->

<!-- dispo_time <- dispo_time %>% -->
<!--               group_by(file_number) %>%  -->
<!--               arrange(file_number, desc(case_stage), desc(filing_date), desc(disposition_date)) %>% -->
<!--               slice(1) %>% -->
<!--               ungroup() -->

<!-- summary(dispo_time) -->

<!-- # export dispo_time to csv for powerbi -->
<!-- # write.csv(dispo_time, '../calculated_data/dispo_time_eda.csv') -->

<!-- # convert new column in to numeric datatype -->
<!-- dispo_time$time_for_dispo_filing <- as.numeric(as.character(dispo_time$time_for_dispo_filing)) -->
<!-- dispo_time$time_for_dispo_arraign <- as.numeric(as.character(dispo_time$time_for_dispo_arraign)) -->

<!-- hist(dispo_time$time_for_dispo_filing) -->
<!-- hist(dispo_time$time_for_dispo_arraign) -->
<!-- ``` -->
<!-- + Time is in days -->

<!-- ```{r} -->
<!-- # merge this "dispo_time" with D11_filed_cases to get demographic info of file numbers -->
<!-- dispo_time_with_cases <- D11_filed_cases %>% -->
<!--         left_join(dispo_time, by = c("file_number")) -->

<!-- ``` -->

<!-- ### Time for disposition vs Gender -->

<!-- ```{r} -->
<!-- # scatter plot for dispo time comparing with filing date -->
<!-- ggplot(dispo_time_with_cases, aes(x=gender, y=time_for_dispo_filing)) +  -->
<!--   geom_point() -->

<!-- summary(dispo_time_with_cases[dispo_time_with_cases$gender == "Male",]) -->
<!-- summary(dispo_time_with_cases[dispo_time_with_cases$gender == "Female",]) -->

<!-- # scatter plot for dispo time comparing with arraignment date -->
<!-- ggplot(dispo_time_with_cases, aes(x=gender, y=time_for_dispo_arraign)) +  -->
<!--   geom_point() -->
<!-- ``` -->

<!-- ```{r} -->
<!-- summary(dispo_time_with_cases[dispo_time_with_cases$gender == "Male",]) -->
<!-- summary(dispo_time_with_cases[dispo_time_with_cases$gender == "Female",]) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- summary(dispo_time_with_charges[dispo_time_with_charges$seriousness >= 10,]) -->
<!-- summary(dispo_time_with_charges[dispo_time_with_charges$seriousness < 5,]) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- summary(dispo_time_with_charges[dispo_time_with_charges$class >= 10,]) -->
<!-- summary(dispo_time_with_charges[dispo_time_with_charges$seriousness < 5,]) -->
<!-- ``` -->

<!-- ### Time for disposition vs Age group -->

<!-- ```{r} -->
<!-- # scatter plot for dispo time comparing with filing date -->
<!-- ggplot(dispo_time_with_cases, aes(x=age_group, y=time_for_dispo_filing)) +  -->
<!--   geom_point() -->

<!-- # scatter plot for dispo time comparing with arraignment date -->
<!-- ggplot(dispo_time_with_cases, aes(x=age_group, y=time_for_dispo_arraign)) +  -->
<!--   geom_point() -->
<!-- ``` -->

<!-- ### Time for disposition vs Venue -->

<!-- ```{r} -->
<!-- # scatter plot for dispo time comparing with filing date -->
<!-- ggplot(dispo_time_with_cases, aes(x=venue, y=time_for_dispo_filing)) +  -->
<!--   geom_point() -->

<!-- # scatter plot for dispo time comparing with arraignment date -->
<!-- ggplot(dispo_time_with_cases, aes(x=venue, y=time_for_dispo_arraign)) +  -->
<!--   geom_point() -->
<!-- ``` -->

<!-- ```{r} -->
<!-- # merge this "dispo_time" with D11_filed_cases to get demographic info of file numbers -->
<!-- dispo_time_with_charges <- D21_D22_charges %>% -->
<!--         left_join(dispo_time, by = c("file_number")) -->

<!-- ``` -->

<!-- ```{r} -->
<!-- summary(dispo_time_with_charges[dispo_time_with_charges$class == 'A',]) -->
<!-- summary(dispo_time_with_charges[dispo_time_with_charges$class == 'B',]) -->
<!-- summary(dispo_time_with_charges[dispo_time_with_charges$class == 'C',]) -->
<!-- ``` -->

<!-- ### Time for disposition vs Charge class -->

<!-- ```{r} -->
<!-- # scatter plot for dispo time comparing with filing date -->
<!-- ggplot(dispo_time_with_charges, aes(x=charge_class, y=time_for_dispo_filing)) +  -->
<!--   geom_point() -->

<!-- # scatter plot for dispo time comparing with arraignment date -->
<!-- ggplot(dispo_time_with_charges, aes(x=charge_class, y=time_for_dispo_arraign)) +  -->
<!--   geom_point() -->

<!-- ``` -->

<!-- ### Time for disposition vs Seriousness -->

<!-- ```{r} -->
<!-- # scatter plot for dispo time comparing with filing date -->
<!-- ggplot(dispo_time_with_charges, aes(x=seriousness, y=time_for_dispo_filing)) +  -->
<!--   geom_point() -->

<!-- # scatter plot for dispo time comparing with arraignment date -->
<!-- ggplot(dispo_time_with_charges, aes(x=seriousness, y=time_for_dispo_arraign)) +  -->
<!--   geom_point() -->

<!-- ``` -->

<!-- ### Time for disposition vs Violent -->

<!-- ```{r} -->
<!-- # scatter plot for dispo time comparing with filing date -->
<!-- ggplot(dispo_time_with_charges, aes(x=is_violent, y=time_for_dispo_filing)) +  -->
<!--   geom_point() -->

<!-- # scatter plot for dispo time comparing with arraignment date -->
<!-- ggplot(dispo_time_with_charges, aes(x=is_violent, y=time_for_dispo_arraign)) +  -->
<!--   geom_point() -->

<!-- ``` -->


<!-- ### Time to disposition -->

<!-- Time to disposition for a case is measured in "days" and is the difference between the earliest filing date and the latest disposition date. -->

<!-- ```{r} -->

<!-- time_to_disposition <- D21_charge %>%  -->
<!--   group_by(file_number) %>%  -->
<!--   mutate( -->
<!--     earliest_filing_date = min(filing_date), -->
<!--     latest_disposition_date = max(disposition_date), -->
<!--     time_to_disposition_days = difftime( -->
<!--       earliest_filing_date, latest_disposition_date, "days" -->
<!--     ) -->
<!--   ) %>%  -->
<!--   select(-c("earliest_filing_date", "latest_disposition_date")) -->

<!-- ``` -->

<!-- ### Finding the representative charge: -->

<!-- + Representative charge: Sort charges based on class, seriousness and violent and rank in ascending order -->
<!-- + Charge codes ranked in alphabetical order in case of tie -->
<!-- + Duplicate charge codes are eliminated by filtering out instances of charge codes after the first instance -->

<!-- ```{r} -->

<!-- # # confirmed that all defendant id's are present in both file case and case event records -->
<!-- # setdiff(unique(D11_filed_cases$defendant_id), unique(D12_case_event$defendant_id)) -->

<!-- # to find the representative charge -->

<!-- charge_code_unique <- D22_charge_def %>%  -->
<!--   arrange(desc(charge_class), desc(seriousness), desc(is_violent), code) %>%  -->
<!--   mutate(charge_rank = 1:n()) %>%  -->
<!--   group_by(code) %>%  -->
<!--   arrange(desc(charge_rank)) %>%  -->
<!--   mutate(charge_code_instance = 1:n()) %>%  -->
<!--   filter(charge_code_instance == 1) %>%  -->
<!--   select(-charge_code_instance) -->

<!-- rep_charge <- D21_charge %>%  -->
<!--   left_join(charge_code_unique, by = c("charge_code" = "code")) %>%  -->
<!--   group_by(file_number) %>%  -->
<!--   select(file_number, charge_code, charge_rank) %>%  -->
<!--   filter(!is.na(charge_code)) %>%  -->
<!--   mutate(max_charge_rank = min(charge_rank)) %>%  -->
<!--   filter(charge_rank == max_charge_rank) %>%  -->
<!--   select(file_number, charge_code) %>%  -->
<!--   unique() -->

<!-- ``` -->

<!-- ### Case Setting Stages -->

<!-- ```{r} -->

<!-- last_arraignment <- D12_case_event %>%  -->
<!--   filter(event_code == "HRARRSC") %>%  -->
<!--   group_by(file_number) %>%  -->
<!--   summarise(arraignment_date = max(event_docket_date)) -->

<!-- first_case_setting <- D12_case_event %>%  -->
<!--   filter(event_code %in% c("HRCSGP", "HRCSNWK", "HRCSNWS", "HRCSWK", "HRCSWS")) %>%  -->
<!--   group_by(file_number) %>%  -->
<!--   summarise(case_setting_date = min(event_docket_date)) -->

<!-- ``` -->

<!-- # ```{r} -->
<!-- # D12_case_event %>%   -->
<!-- #   mutate( -->
<!-- #     event_group = fct_collapse( -->
<!-- #       event_code, -->
<!-- #       arraignment = c("HRARRSC"), -->
<!-- #       case_setting = c("HRCSGP", "HRCSNWK", "HRCSNWS", "HRCSWK", "HRCSWS"),  -->
<!-- #       group_other = TRUE -->
<!-- #     ) -->
<!-- #   ) %>%  -->
<!-- #   group_by(event_group) %>%  -->
<!-- #   summarise(no_of_cases = n_distinct(file_number)) %>%  -->
<!-- #   arrange(desc(no_of_cases)) -->
<!-- # ``` -->

